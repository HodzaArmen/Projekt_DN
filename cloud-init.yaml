#cloud-config
package_update: true
package_upgrade: true

packages:
  - python3
  - python3-pip
  - python3-venv
  - docker.io
  - unzip
  - curl
  - nginx

runcmd:
  - mkdir -p /opt/todo_app
  - cd /opt/todo_app

  # Redis container
  - docker run -d --name redis -p 6379:6379 redis || echo "Redis already running"

  # Python environment
  - python3 -m venv /opt/todo_app/venv
  - /opt/todo_app/venv/bin/pip install --upgrade pip

  # Download your app
  - curl -L -o /opt/todo_app/ToDo.zip https://github.com/HodzaArmen/Projekt_DN/raw/main/ToDo.zip
  - unzip -o /opt/todo_app/ToDo.zip -d /opt/todo_app
  - /opt/todo_app/venv/bin/pip install -r /opt/todo_app/ToDo/requirements.txt

  # Systemd service
  - |
    cat > /etc/systemd/system/todo.service << EOF
    [Unit]
    Description=ToDo Flask App
    After=network.target docker.service
    Requires=docker.service

    [Service]
    User=root
    WorkingDirectory=/opt/todo_app/ToDo
    ExecStart=/opt/todo_app/venv/bin/python app.py
    Restart=always

    [Install]
    WantedBy=multi-user.target
    EOF

  - systemctl daemon-reload
  - systemctl enable todo.service
  - systemctl start todo.service

  # NGINX config (HTTP only)
  - |
    cat > /etc/nginx/sites-available/todo << EOF
    server {
        listen 80;

        location / {
            proxy_pass http://127.0.0.1:5000;
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        }
    }
    EOF

  - ln -sf /etc/nginx/sites-available/todo /etc/nginx/sites-enabled/todo
  - rm -f /etc/nginx/sites-enabled/default
  - systemctl restart nginx

  # firewall
  - ufw allow 80
  - ufw --force enable
